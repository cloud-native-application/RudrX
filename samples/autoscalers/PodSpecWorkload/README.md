# Scaling PodSpecWorkload with cron and cpu utilization metrics

## Prerequisites
- [ ] HPA with metrics-server enabled
- [ ] [KEDA](https://keda.sh/docs/2.0/deploy/) v2.0 Beta

## Deploy deployment and KEDA
  - Apply these manifests to deploy PodSpecWorkload with Trait Autoscaler
    ```
    $ kubectl apply -f .
    ```
    
  - Check the replicas of the Deployment generated by PodSpecWorkload
    ```
    $ kubectl get deployment --watch
    NAME               READY   UP-TO-DATE   AVAILABLE   AGE
    component-scaler   0/1     0            0           0s
    component-scaler   0/1     0            0           0s
    component-scaler   0/1     0            0           0s
    component-scaler   0/1     0            0           0s
    component-scaler   0/1     1            0           0s
    component-scaler   1/1     1            1           1s
    component-scaler   1/1     1            1           28s
    component-scaler   1/2     1            1           40s
    component-scaler   1/2     1            1           40s
    component-scaler   1/2     1            1           40s
    component-scaler   1/2     2            1           40s
    component-scaler   2/2     2            2           41s
    ```
  
  - Wait `ScaledObject` to take effect
    ```
    $ kubectl get scaledobject.keda.sh --watch
    trait-scaler                        component-scaler   cron                        Unknown   Unknown   0s
    trait-scaler                        component-scaler   cron                        Unknown   Unknown   0s
    trait-scaler   apps/v1.Deployment   component-scaler   cron                        Unknown   Unknown   0s
    trait-scaler   apps/v1.Deployment   component-scaler   cron                        Unknown   Unknown   0s
    trait-scaler   apps/v1.Deployment   component-scaler   cron                        True      Unknown   0s
    trait-scaler   apps/v1.Deployment   component-scaler   cron                        True      Unknown   0s
    trait-scaler   apps/v1.Deployment   component-scaler   cron                        True      True      1s
    trait-scaler   apps/v1.Deployment   component-scaler   cron                        True      True      31s
    ```
    The replicas of Deployment will change to 4.
    ```shell
    $ kubectl get deployment --watch
    component-scaler   2/4     2            2           5m47s
    component-scaler   2/4     2            2           5m47s
    component-scaler   2/4     2            2           5m47s
    component-scaler   2/4     4            2           5m47s
    component-scaler   3/4     4            3           5m59s
    component-scaler   4/4     4            4           5m59s
    ```
  
  - Visit the Deployment with a heavy load.
    ```
    $ sudo k port-forward deploy/component-scaler 80
    $ ab -n 10000 -c 100 http://127.0.0.1/
    ```
      
  - Monitor the Deployment
    The replicas of the Deployment changes from 4 to 8, and to 10 at last. And after stopping ab, it will be scaled down
    to 4.
    ```shell
    component-scaler   4/8     4            4           7m5s
    component-scaler   4/8     4            4           7m5s
    component-scaler   4/8     4            4           7m5s
    component-scaler   4/8     8            4           7m6s
    component-scaler   5/8     8            5           7m16s
    component-scaler   6/8     8            6           7m16s
    component-scaler   7/8     8            7           7m16s
    component-scaler   8/8     8            8           7m16s
    component-scaler   8/10    8            8           7m20s
    component-scaler   8/10    8            8           7m20s
    component-scaler   8/10    8            8           7m20s
    component-scaler   8/10    10           8           7m20s
    component-scaler   9/10    10           9           7m22s
    component-scaler   10/10   10           10          7m22s
    component-scaler   10/4    10           10          12m
    component-scaler   10/4    10           10          12m
    component-scaler   8/4     8            8           12m
    component-scaler   4/4     4            4           12m
    ```
